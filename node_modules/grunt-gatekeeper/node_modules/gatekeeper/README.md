# AppleConnect Gatekeeper

* ACG runs as a lightweight, user facing HTTP server/client proxy.
* ACG initiates and tracks AppleConnect sessions
* Destination services are HTTP services or static assets that are only accessible via the AppleConnect Gatekeeper
* All incoming requests are authenticated against AppleConnect before proxying to the destination service.
* If not authenticated, the destination service is never queried.
  * Unauthenticated requests can be configured to return either a JSON error or 301 Redirect
* ACG sends X-AppleConnect-\* headers to the destination service
* The destination service considers the user to be authenticated as the person identified by this value


## Requirements

* node/npm


## Instructions

Install the global gatekeeper command line utility

* clone gatekeeper
* npm install
* npm link

Run tests with `npm test`


## Usage

**gatekeeper init**

Writes a default gatekeeper.json that can be used with `gatekeeper server`

**gatekeeper server**

Starts a gatekeeper server that forwards to specified host and port

Options:

* -c, --conf <filename> Specify a config file to load in (generated from gatekeeper init)
* -p, --port <port> Specify what port the gatekeeper server listened on
* -o, --offline Use appleconnect in offline mode
* -s, --https Use https server
* --forward-host <host> Host that gatekeeper server forwards to
* --forward-port <port> Port on host that gatekeeper server forwards to


## Headers

AppleConnect Gatekeeper provides the following headers to destination services

* x-appleconnect-dsid
* x-appleconnect-type
* x-appleconnect-email
* x-appleconnect-groups
* x-appleconnect-first
* x-appleconnect-last
* x-appleconnect-nick


## CSRF Protection

AppleConnect Gatekeeper enforces CSRF protection for any requests other than GET/HEAD/OPTIONS

All responses include a token in the X-CSRF-Token header that should be included in these requests
in a X-CSRF-Token request header, \_csrf form field or \_csrf GET parameter

More info at: http://www.senchalabs.org/connect/csrf.html


## Load balancing

To load balance (round-robin) between multiple destination servers, add the following to your config json:

      "destinationServers": [
        {
          "host": "md1.apple.com",
          "port": 80
        }, {
          "host": "md2.apple.com",
          "port": 80
        }
      ],

This will override the --forward-host and --forward-port options as well as any forwardHost or forwardPort specified in the config.


## Static assets

Gatekeeper will serve static assets when forwardHost is specified with a file:// url:

      "forwardHost": "file:///absolute/path/to/assets"

or

      --forward-host file:///absolute/path/to/assets


forwardPort is ignored in this case.  file:// urls can not be used with load balancing.

Optionally defaultStaticFile can also be specified (relative the file:// url) to return a given file for all requests that don't match any other file
