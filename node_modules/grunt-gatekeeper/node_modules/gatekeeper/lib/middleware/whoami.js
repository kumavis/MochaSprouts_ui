var appleconnect = require('../appleconnect');

module.exports = function() {
  return function(req, res, next) {
    if (req.url == '/whoami.json') {
      var ac = req.session.AppleConnect;
      res.end(JSON.stringify({
        dsid:   parseInt(ac.prsId),
        first:  ac.firstName,
        last:   ac.lastName,
        nick:   ac.nickName,
        type:   appleconnect.getPersonTypeName(ac.prsTypeCode),
        email:  ac.emailAddress,
        groups: ac.allGroups.split(';').filter(function(item) {
                  return item != '';
                }).map(function(item) {
                  return parseInt(item);
                })
      }));
    } else {
      next();
    }
  }
};
