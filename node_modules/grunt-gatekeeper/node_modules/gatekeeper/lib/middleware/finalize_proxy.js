var httpProxy = require('http-proxy'),
    extend    = require('xtend');

module.exports = function(destinationServers) {
  var proxy = new httpProxy.RoutingProxy();
  return function(req, res, next) {
    // Round robin load balancing
    var server = destinationServers.shift();
    var proxyOptions = extend(server, {
      buffer: req.buffer
    });
    proxy.proxyRequest(req, res, proxyOptions);
    destinationServers.push(server);
  };
};

