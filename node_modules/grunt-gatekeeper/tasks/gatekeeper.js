/*
 * grunt-gatekeeper
 * http://gh.apple.com/kumavis/grunt-gatekeeper
 */


module.exports = function(grunt) {
  'use strict';

  var Async = require('async');
  var Gatekeeper = require('./lib/gatekeeper').init(grunt);

  grunt.registerMultiTask('gatekeeper', 'Make grunt tasks to spin up gatekeeper instances.', function() {
    var done, self = this, servers, serverTasks;

    // Make Async
    done = this.async();

    // Grab Servers
    servers = Object.keys(this.data).map(function(key) {
      return self.data[key];
    });

    // Create Server Tasks
    serverTasks = servers.map(function(server) {
      return function(next) {
        Gatekeeper.spinUp(server, next);
      };
    });

    // Start the Server
    Async.parallel(serverTasks,function(err) {
      if (err) {
        grunt.warn(err);
      } else {
        grunt.log.ok();
        done(); // Complete Task
      }
    });
  });
};
